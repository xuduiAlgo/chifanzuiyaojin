# 离线导出功能测试指南

## 问题修复说明

本次修复解决了 ASR 历史记录离线导出时无法灵活选择音频/视频的问题。

### 原问题
- 在历史记录详情页面，当用户切换"包含视频"或"仅音频"选项并多次点击导出时，会出现状态混乱
- 导致导出的文件要么全是音频，要么全是视频，无法按用户选择正确导出

### 修复方案
1. **避免修改原始 record 对象**：创建工作副本，防止状态污染
2. **独立处理导出模式**：使用局部变量和明确的参数传递
3. **清晰的逻辑判断**：确保 `fileType` 和 `exportMode` 正确传递到 HTML 生成函数

## 测试步骤

### 测试场景 1：ASR 视频文件 - 仅音频导出

1. 打开应用，进入 ASR 功能
2. 上传一个视频文件（如 .mp4 或 .mkv）进行转写
3. 等待转写完成
4. 点击"历史记录"按钮，查看刚生成的记录
5. 点击该记录进入详情页
6. 在导出选项中选择 **"仅音频"**
7. 点击"📥 导出离线HTML文件"按钮
8. 打开下载的 HTML 文件

**预期结果**：
- HTML 文件中应该显示 **音频播放器**（`<audio>` 标签）
- 播放器只能播放音频，没有视频画面

### 测试场景 2：ASR 视频文件 - 包含视频导出

1. 使用同一个视频文件的 ASR 记录
2. 点击该记录进入详情页
3. 在导出选项中选择 **"包含视频"**
4. 点击"📥 导出离线HTML文件"按钮
5. 打开下载的 HTML 文件

**预期结果**：
- HTML 文件中应该显示 **视频播放器**（`<video>` 标签）
- 播放器可以播放视频和音频

### 测试场景 3：多次切换选择

1. 使用同一个视频文件的 ASR 记录
2. 选择"仅音频"，点击导出
3. 打开第一个 HTML 文件，确认是音频播放器
4. 返回历史详情页
5. 切换到"包含视频"，点击导出
6. 打开第二个 HTML 文件，确认是视频播放器
7. 返回历史详情页
8. 再次切换回"仅音频"，点击导出
9. 打开第三个 HTML 文件，确认又是音频播放器

**预期结果**：
- 每次导出都应该按照当前选择正确生成
- 不会出现状态混乱的问题
- 音频和视频导出可以灵活切换

### 测试场景 4：ASR 音频文件

1. 上传一个纯音频文件（如 .mp3、.wav）进行转写
2. 完成后查看历史记录
3. 点击该记录进入详情页

**预期结果**：
- 导出选项区域应该**隐藏**（因为是音频文件，没有视频选项）
- 点击导出按钮，生成的 HTML 文件应该是音频播放器

### 测试场景 5：TTS 历史记录

1. 使用 TTS 功能生成一段语音
2. 查看历史记录，点击该记录
3. 点击导出按钮

**预期结果**：
- TTS 记录没有导出选项（只有音频）
- 生成的 HTML 文件应该是音频播放器

## 验证 HTML 文件内容

要确认导出的 HTML 文件是否正确，可以使用以下方法：

### 方法 1：查看源代码
1. 在浏览器中打开导出的 HTML 文件
2. 右键点击页面，选择"查看页面源代码"
3. 搜索 `<audio>` 或 `<video>` 标签

- **音频导出**：应该找到 `<audio id="mediaPlayer" controls ...>`
- **视频导出**：应该找到 `<video id="mediaPlayer" controls ...>`

### 方法 2：查看播放器标签文本
在打开的 HTML 文件页面中：
- **音频播放器**：标签文字应该显示"音频播放器"
- **视频播放器**：标签文字应该显示"视频播放器"

### 方法 3：检查播放器功能
- **音频播放器**：没有视频画面，只有进度条和控制按钮
- **视频播放器**：有视频画面显示区域

## 常见问题排查

### 问题：导出的 HTML 文件仍然是视频播放器，但选择的是"仅音频"

**可能原因**：
1. 浏览器缓存了旧的 JavaScript 文件
2. 服务器没有重启，仍在运行旧代码

**解决方法**：
1. 在浏览器中按 `Ctrl+Shift+R`（Windows）或 `Cmd+Shift+R`（Mac）强制刷新
2. 重启服务器：`python server.py`

### 问题：导出选项没有显示

**可能原因**：
1. 历史记录中的 `fileType` 字段不正确
2. 历史记录是旧数据（修复前创建的）

**解决方法**：
1. 确认 ASR 转写时正确识别了文件类型
2. 尝试重新转写一个视频文件，生成新的历史记录
3. 检查浏览器控制台是否有错误信息

### 问题：音频提取失败

**可能原因**：
1. 视频文件 URL 格式不正确
2. 服务器音频提取功能未正常工作

**解决方法**：
1. 检查浏览器控制台的错误信息
2. 确认服务器日志中没有错误
3. 尝试重新上传文件进行转写

## 技术细节

### 代码改动

#### 1. exportTTSHistory 函数
```javascript
// 修改前：直接修改 record
record.audioUrl = base64Audio;

// 修改后：使用局部变量
const workingRecord = { ...record };
let finalAudioUrl = record.audioUrl;
finalAudioUrl = await this.convertToBase64(finalAudioUrl);
// 传递新对象而不是修改原始 record
return this.generateOfflineHTML({
    ...workingRecord,
    audioUrl: finalAudioUrl
}, 'tts');
```

#### 2. exportASRHistory 函数
```javascript
// 修改前：直接修改 record
record.exportMode = exportMode;
record.audioUrl = data.audio_url;

// 修改后：使用局部变量和明确传递
const workingRecord = { ...record };
let finalAudioUrl = originalAudioUrl;
// ... 处理逻辑 ...
return this.generateOfflineHTML({
    ...workingRecord,
    audioUrl: finalAudioUrl,
    exportMode: exportMode,  // 明确传递导出模式
    fileType: record.fileType   // 明确传递文件类型
}, 'asr');
```

### 关键改进点

1. **不可变性**：不修改传入的参数对象
2. **明确的参数传递**：所有需要的参数都显式传递
3. **局部变量**：使用局部变量存储中间结果
4. **清晰的逻辑流**：从 URL 处理到 HTML 生成，每个步骤都独立

## 日志和调试

如果在测试过程中遇到问题，可以：

1. **打开浏览器控制台**（F12）
2. **查看 Console 标签**，寻找错误信息
3. **查看 Network 标签**，检查 API 请求是否成功
4. **查看服务器日志**：`tail -f logs/server.log`

关键日志信息：
- `Extracting audio from video...` - 开始提取音频
- `Audio extracted successfully` - 音频提取成功
- `Converting to base64` - 开始转换为 base64
- `Base64 conversion completed` - 转换完成

## 总结

通过本次重构，离线导出功能现在可以：
- ✅ 灵活选择音频或视频导出
- ✅ 支持多次切换选择
- ✅ 避免状态污染和混乱
- ✅ 保持原始记录对象的完整性

请按照上述测试步骤进行全面测试，确保功能正常工作。
