# 进度追踪功能测试指南

## 概述

本文档说明如何测试基于实际日志的进度追踪功能。该功能通过解析服务器日志中的关键事件，为ASR和TTS操作提供准确的实时进度。

## 实现原理

### 进度映射规则

#### ASR（语音转文字）进度映射

| 日志事件 | 进度百分比 | 说明 |
|---------|----------|------|
| 开始处理 | 0% | 初始化 |
| Audio too long (Xs), splitting... | 10% | 检测到长音频，开始分割 |
| Processing chunk 1/13... | 10-90% | 根据当前分片动态计算<br>公式：`10% + (当前分片/总分片 × 80%)` |
| ASR Trying model: qwen3-omni-flash-2025-12-01 | 90% | 开始尝试模型 |
| ASR completed successfully | 100% | 完成 |

#### TTS（文字转语音）进度映射

| 日志事件 | 进度百分比 | 说明 |
|---------|----------|------|
| 开始生成 | 10% | 初始化 |
| 发送请求到API | 30% | API调用 |
| 处理响应 | 70% | 接收和处理音频数据 |
| 完成 | 100% | 完成 |

### 关键改进

1. **实时日志捕获**：所有stderr输出立即写入日志文件，不缓冲
2. **时间戳格式化**：统一使用 `YYYY-MM-DD HH:MM:SS - LEVEL` 格式
3. **日志刷新机制**：每条日志写入后立即flush，确保前端能读取最新日志
4. **精确进度计算**：基于实际处理步骤而非时间估算

## 测试步骤

### 1. 启动服务器

```bash
cd /Users/xuwenming/Documents/trae_projects/XUDUI/chifanzuiyaojin
python server.py
```

### 2. 打开浏览器

访问：`http://localhost:5173`

### 3. 测试ASR进度追踪

#### 测试场景A：短音频（< 300秒）

1. 上传一个短音频文件（< 5分钟）
2. 观察进度条
3. 打开浏览器控制台（F12）
4. 查看 `[LogParser]` 日志输出

**预期行为**：
- 进度应该快速从0%跳到100%
- 日志中应该看到模型尝试和完成的消息

#### 测试场景B：长音频（> 300秒）

1. 上传一个长音频文件（> 5分钟）
2. 观察进度条
3. 打开浏览器控制台
4. 查看 `[LogParser]` 日志输出

**预期行为**：
- 进度应该先显示 "正在分割音频..."（10%）
- 然后逐个显示分片处理进度（10% → 90%）
- 例如 "正在处理分片 1/13..."、"正在处理分片 2/13..."
- 最后显示 "即将完成..."（90%）→ "完成"（100%）

**关键验证点**：
- 分片进度应该平滑增长
- 如果有13个分片，每个分片大约增加 80% / 13 ≈ 6.15%

### 4. 测试TTS进度追踪

1. 输入较长的文本（> 500字符）
2. 点击"生成语音"按钮
3. 观察进度条和状态文本

**预期行为**：
- 显示 "开始生成..."（10%）
- 显示 "正在发送请求..."（30%）
- 显示 "正在处理响应..."（70%）
- 显示 "完成"（100%）

### 5. 验证日志系统

#### 检查服务器日志文件

```bash
tail -f /Users/xuwenming/Documents/trae_projects/XUDUI/chifanzuiyaojin/logs/server.log
```

**预期输出**：
- 每条日志都应该有时间戳
- 格式：`2026-01-18 08:20:32 - INFO - <消息内容>`
- 日志应该立即写入，无需等待缓冲

**关键日志事件**：

对于长音频ASR：
```
2026-01-18 08:20:45 - INFO - Audio too long (1414.96s), splitting...
2026-01-18 08:21:00 - INFO - Processing chunk 1/13...
2026-01-18 08:21:15 - INFO - Processing chunk 2/13...
...
2026-01-18 08:25:30 - INFO - ASR Trying model: qwen3-omni-flash-2025-12-01
```

对于TTS：
```
2026-01-18 08:20:50 - INFO - Starting TTS generation
2026-01-18 08:20:52 - INFO - Sending request to Qwen-TTS API
2026-01-18 08:21:10 - INFO - Processing TTS response
```

### 6. 测试API日志接口

在浏览器中访问：

```
http://localhost:5173/api/logs?lines=50
```

**预期返回**：
```json
{
  "ok": true,
  "logs": [
    "2026-01-18 08:20:32 - INFO - === Server Started ===",
    "2026-01-18 08:20:32 - INFO - Logging system initialized. All stderr output will be captured.",
    ...
  ],
  "count": 50
}
```

### 7. 测试过滤器

访问带有过滤器的日志接口：

```
http://localhost:5173/api/logs?lines=100&filter=Processing chunk
```

**预期返回**：只包含匹配 "Processing chunk" 的日志行

## 故障排除

### 问题1：进度条不更新

**可能原因**：
- 日志文件路径不正确
- 日志文件权限问题
- 前端轮询失败

**解决方案**：
1. 检查日志文件是否存在：
   ```bash
   ls -la /Users/xuwenming/Documents/trae_projects/XUDUI/chifanzuiyaojin/logs/server.log
   ```

2. 检查日志文件是否有写入权限

3. 打开浏览器控制台，查看是否有错误

### 问题2：日志没有时间戳

**可能原因**：
- 服务器没有重启
- 日志系统初始化失败

**解决方案**：
1. 重启服务器
2. 检查日志文件开头是否有 "=== Server Started ===" 消息

### 问题3：进度显示不准确

**可能原因**：
- 日志格式与正则表达式不匹配
- 日志被缓冲，前端读取的是旧日志

**解决方案**：
1. 检查实际的日志格式
2. 更新 `js/log-parser.js` 中的正则表达式
3. 确认日志立即刷新（检查 `LogWriter.flush()` 调用）

### 问题4：分片进度不连续

**可能原因**：
- 某些分片处理失败
- 日志丢失

**解决方案**：
1. 查看完整日志，确认是否有错误信息
2. 检查分片处理是否有异常

## 性能指标

### 正常性能

- **轮询间隔**：1秒
- **API响应时间**：< 100ms
- **日志文件大小**：每个文件最大10MB
- **进度更新延迟**：< 2秒

### 预期进度时间线（示例）

**长音频ASR（1414秒，13个分片）**：
- 0-30秒：分割音频（10%）
- 30-480秒：处理13个分片（10% → 90%，每个分片约35秒）
- 480-520秒：模型尝试（90%）
- 520-540秒：完成（100%）

**总时间**：约9分钟

## 后续优化建议

1. **WebSocket替代轮询**：使用WebSocket实现真正的实时进度推送
2. **进度缓存**：在服务器端缓存进度状态，减少日志读取开销
3. **智能轮询**：根据处理阶段动态调整轮询频率
4. **进度预估**：基于历史数据预估剩余时间
5. **错误恢复**：检测到错误时提供恢复建议

## 相关文件

- **后端**：
  - `server.py` - 日志系统和API接口
  - `logs/server.log` - 服务器日志文件

- **前端**：
  - `js/log-parser.js` - 日志解析器
  - `js/progress-tracker.js` - 进度追踪管理器
  - `js/progress-indicator.js` - 进度指示器UI组件
  - `app.js` - 主应用逻辑（集成进度追踪）

- **文档**：
  - `docs/PROGRESS_TRACKING.md` - 进度追踪设计文档
  - `docs/PROGRESS_TESTING.md` - 本文档
